# フロントエンドアーキテクチャ

## 概要

このフロントエンドプロジェクトは、クリーンアーキテクチャの考え方を基にし、Next.js 特有の要件（Server/Client 分離）を考慮したレイヤー設計を採用しています。
コードの依存関係を明確にし、テスタビリティと保守性を高めることを目的としています。

## アーキテクチャ構成

基本方針：このプロジェクトでは、名前空間の概念として捉えているため、フォルダ名は単数形で統一しています。

```
frontend/
├──public/                    # 静的ファイル
   └── image/                 # 画像などの静的ファイル
└──src/
   ├── __test__/              # テスト用フォルダ
   ├── app/                   # Next.js App Routerのページとグローバル設定
   ├── component/
   │   ├── functional/        # ビジネスロジックや副作用を内包する共通コンポーネント
   │   └── functionless/      # ビジネスロジックや副作用を持たず、外部から受け取ったものをそのまま使うだけの共通コンポーネント
   │   └── client-page/       # React Hooksやビジネスロジック、副作用をもつことのできるページ固有のコンポーネント
   │        └── action.ts/    # client-pagesの操作を理解しているフォームアクションロジックを定義する。ドメインロジックではない。
   ├── constant/              # 定数定義
   ├── core/
   │    └── service/          # 外部ライブラリの設定・カスタマイズ
   ├── domain/
   │   ├── data/              # Entity定義
   │   └── logic/
   │       ├── ssr/           # SSR用ロジック（src/app配下で利用する。各画面の初期表示のための取得ロジック）
   │       ├── action/        # SSR以外のNext.jsサーバーで行うべき、CRUDなどのロジック（client-pages/actions.tsで利用する。各画面の初期表示後のCRUDロジック）
   │       └── util/          # 汎用ロジック用ロジック
   └── util/                  # ユーティリティ関数
       └── hook/              # 汎用的なカスタムフック
```

## フォルダ構成

### src/app/

- src/component/client-page/を呼び出す。

- page.tsx・・・必ず server component で定義する。
- error.tsx,loading.tsx,not-found.tsx・・・エラーハンドリングとローディング状態の管理する。
- layout.tsx・・・レイアウト設定。
- globals.css・・・グローバルスタイル。

### src/component/functional/

- component/client-pages/ 配下で利用される。

### src/component/functionless/

- component/client-pages/ 配下で利用される。

### src/component/client-page/

- src/app/配下で利用される。
- ServerComponent でも ClientComponent でも可能。
- ここでは、domain/logic/action/を直接呼ばず必ず client-page/action.ts を呼ぶ。
- シンプルなハンドラー関数はファイル内に直接定義しても良い。
- 例：検索などでバリデーション・URL パラメータ操作のみの場合はファイル内に直接ロジックを定義し使用する。

### src/component/client-page/action.ts

- domain/logic/action/を呼び出す。

### src/domain/logic/ssr/ & src/domain/logic/action/

- アプリの言葉や知識が出てくる（Entity など。）
- React View の概念が出てこない。
- Entity の操作（書き込み、保存、配列操作などの計算）のための外部通信をモックで置き換え可能な状態。
- 外部通信には core/service/ を呼び出す。
- 外部通信先の情報の内部までを知る必要がない。
- コンポーネントに直接関係しない変換処理やドメインロジックを含む。
- エラー時は Result 型を返す。
- 悪い例：httpError がこの関数から出てくることのようないようにする。

### src/**test**/

- domain/ core/ util/ action.ts のテストを行う。
- フォルダはミラー構造にする。

## ローディング状態の管理方針

基本的な考え方：サーバーサイドとクライアントサイドで、それぞれ適切なローディング表示を使い分ける。

### サーバーサイドレンダリング（SSR）の場合

- Next.js の loading.tsx ファイルを使って、ページ全体のローディングを表示する。
- ユーザーがページにアクセスした時の初期表示時に適用される。

### クライアントサイドレンダリング（CSR）の場合

- ClientComponentLoading コンポーネントを使用する。
- Server Action を使ったフォーム操作の場合は、useActionState の isPending などを監視する。
- その他のクライアント操作の場合は、useState や useTransition の状態を監視する。ボタンクリックや画面遷移などの操作中にローディングを表示する。

## エラーハンドリング方針

基本的な考え方:domain/logic 配下では外部通信の詳細を隠蔽し、予期可能なエラーは Result 型で統一的に処理します。

### domain/logic 配下での設計原則

- 外部通信の詳細を隠蔽: HTTP エラーコードや API の内部仕様を上位層に漏らしません。
- Result 型によるエラー表現: 予期するエラーは例外(throw)ではなく、Result 型で返却します。
- 一貫したエラー処理: 成功・失敗の状態を型安全に表現します。

### サーバーサイドレンダリング（SSR）でのエラー処理

- Result 型のエラー: 一律で not-found 画面に遷移させます。
- 予期せぬエラー発生時は error.tsx で統一します。

### クライアントサイドレンダリング（CSR）のエラー処理

#### Server Actions 内での処理:

- Result 型のエラー: Server Actions 内で定義したエラーメッセージを設定して return します
- 予期しないエラー: Server Actions 内で定義した固定のエラーメッセージを設定して return します
- 必ずエラー状態を含んだレスポンスを返却します。

#### クライアント側での処理:

- フォームアクション: 受け取ったエラーメッセージを toast 表示でユーザーに伝えます
- エラーの種類に関わらず、一貫した UI 表現を提供します
- フォームアクション以外で予期しないエラーが発生した場合は、フォールバックの UI として error.tsx が表示されます。

## テスト方針

- [テスト方針](/docs/rules/frontend/test.md)
- [Service テスト実装ガイド](/docs/rules/frontend/test/service-test.md)
- [Domain テスト実装ガイド](/docs/rules/frontend/test/domain-test.md)
- [Util テスト実装ガイド](/docs/rules/frontend/test/util-test.md)
- [ServerAction テスト実装ガイド](/docs/rules/frontend/test/server-action-test.md)

## スタイル方針

## フォーマット・リント

## CI

## エラー
