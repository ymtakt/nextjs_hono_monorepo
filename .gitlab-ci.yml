# GitLab CI/CD ãƒ¢ãƒãƒ¬ãƒè¨­å®š
# Frontend/Backendåˆ†é›¢å‹ãƒ†ã‚¹ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ï¼ˆMRå¯¾å¿œï¼‰

stages:
  - lint
  - test
  - build

variables:
  NODE_VERSION: "20"
  HUSKY: 0
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
.cache_template: &cache_template
  cache:
    key:
      files:
        - package-lock.json
        - package.json
    paths:
      - node_modules/
      - typescript/frontend/node_modules/
      - typescript/backend/node_modules/
      - typescript/backend/generated/
    policy: pull-push

# å…±é€šãƒ«ãƒ¼ãƒ«
.common_rules: &common_rules
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# å…±é€šã®Prismaç”Ÿæˆå‡¦ç†
.generate_prisma: &generate_prisma
  - echo "ğŸ”§ Generating Prisma client..."
  - cd typescript/backend
  - npm run db:generate
  - cd ../..

# Lintãƒã‚§ãƒƒã‚¯ï¼ˆå…¨ä½“ï¼‰
lint:check:
  stage: lint
  image: node:${NODE_VERSION}
  <<: *cache_template
  before_script:
    - echo "ğŸ“¦ Installing dependencies..."
    - npm install
    - *generate_prisma
  script:
    - echo "ğŸ” Running lint checks..."
    - npm run check:ci
  <<: *common_rules

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
test:frontend:
  stage: test
  image: node:${NODE_VERSION}
  <<: *cache_template
  before_script:
    - npm install
    - *generate_prisma
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®generatedãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒªãƒ³ã‚¯ã™ã‚‹
    - echo "ğŸ”— Linking Prisma client for frontend build..."
    - mkdir -p typescript/frontend/node_modules/backend/generated
    - cp -r typescript/backend/generated/* typescript/frontend/node_modules/backend/generated/
  script:
    - echo "ğŸ§ª Running frontend tests with Node.js..."
    - cd typescript/frontend
    - npm run test:run
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - typescript/frontend/**/*
        - package.json
        - package-lock.json
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
test:backend:
  stage: test
  image: node:${NODE_VERSION}
  services:
    - name: postgres:15
      alias: postgres
  variables:
    POSTGRES_DB: myapp_test
    POSTGRES_USER: testuser
    POSTGRES_PASSWORD: testpass
    POSTGRES_HOST_AUTH_METHOD: trust
    DATABASE_URL: "postgresql://testuser:testpass@postgres:5432/myapp_test"
  <<: *cache_template
  before_script:
    # PostgreSQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - apt-get update -qq && apt-get install -y -qq postgresql-client
    # PostgreSQLã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿ
    - echo "â³ PostgreSQLã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
    - until pg_isready -h postgres -p 5432 -U testuser; do sleep 1; done
    - npm install
    - *generate_prisma
  script:
    - echo "ğŸ§ª Running backend tests with Node.js..."
    - cd typescript/backend
    - npm run test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - typescript/backend/**/*
        - package.json
        - package-lock.json
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ï¼ˆMRã®ã¿ï¼‰
build:frontend:
  stage: build
  image: node:${NODE_VERSION}
  <<: *cache_template
  before_script:
    - npm install
    - *generate_prisma
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®generatedãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒªãƒ³ã‚¯ã™ã‚‹
    - echo "ğŸ”— Linking Prisma client for frontend build..."
    - mkdir -p typescript/frontend/node_modules/backend/generated
    - cp -r typescript/backend/generated/* typescript/frontend/node_modules/backend/generated/
  script:
    - echo "ğŸ—ï¸ Building frontend for validation..."
    - cd typescript/frontend
    - npm run build
  artifacts:
    paths:
      - typescript/frontend/.next/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - typescript/frontend/**/*
        - typescript/backend/**/* # backendã®å¤‰æ›´ã‚‚frontendãƒ“ãƒ«ãƒ‰ã®å¯¾è±¡ã«ã™ã‚‹
        - package.json
        - package-lock.json
