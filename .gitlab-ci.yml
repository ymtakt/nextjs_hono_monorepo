# GitLab CI/CD ãƒ¢ãƒãƒ¬ãƒè¨­å®š
# å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿œã˜ãŸæ¡ä»¶åˆ†å²å¯¾å¿œ

stages:
  - lint
  - test
  - coverage-report

variables:
  NODE_VERSION: "20"
  HUSKY: 0
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šï¼ˆä¿®æ­£ç‰ˆï¼‰
.cache_template: &cache_template
  cache:
    key:
      files:
        - bun.lock
        - package.json
    paths:
      - node_modules/
      - typescript/frontend/node_modules/
      - typescript/backend/node_modules/
      - .npm/
    policy: pull-push

# æ¡ä»¶åˆ†å²ãƒ«ãƒ¼ãƒ«å®šç¾©
.rules_frontend: &rules_frontend
  rules:
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¤‰æ›´æ™‚
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - typescript/frontend/**/*
        - package.json
        - bun.lock
    # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¯å¸¸ã«å®Ÿè¡Œ
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

.rules_backend: &rules_backend
  rules:
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¤‰æ›´æ™‚
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - typescript/backend/**/*
        - package.json
        - bun.lock
    # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¯å¸¸ã«å®Ÿè¡Œ
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

.rules_lint: &rules_lint
  rules:
    # ã„ãšã‚Œã‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - typescript/**/*
        - "*.{js,ts,json,md}"
        - package.json
        - bun.lock
    # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¯å¸¸ã«å®Ÿè¡Œ
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå…±é€šã‚¸ãƒ§ãƒ–ï¼‰
install_dependencies:
  stage: .pre
  image: oven/bun:latest
  <<: *cache_template
  script:
    - echo "ğŸ“¦ Installing dependencies..."
    - bun install
    # Frontendä¾å­˜é–¢ä¿‚ï¼ˆæ¡ä»¶ä»˜ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
    - |
      if [ -n "$(git diff --name-only origin/$CI_DEFAULT_BRANCH HEAD | grep '^typescript/frontend/')" ] || [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        echo "ğŸ“¦ Installing frontend dependencies..."
        cd typescript/frontend && bun install
      fi
    # Backendä¾å­˜é–¢ä¿‚ï¼ˆæ¡ä»¶ä»˜ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
    - |
      if [ -n "$(git diff --name-only origin/$CI_DEFAULT_BRANCH HEAD | grep '^typescript/backend/')" ] || [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        echo "ğŸ“¦ Installing backend dependencies..."
        cd typescript/backend && bun install
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - typescript/**/*
        - package.json
        - bun.lock
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Lintãƒã‚§ãƒƒã‚¯ï¼ˆæ¡ä»¶åˆ†å²ï¼‰
lint:check:
  stage: lint
  image: oven/bun:latest
  cache:
    <<: *cache_template
    policy: pull
  script:
    - echo "ğŸ” Running lint checks..."
    - bun run check:ci
  needs: ["install_dependencies"]
  <<: *rules_lint

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¤‰æ›´æ™‚ã®ã¿ï¼‰
test:frontend:
  stage: test
  image: oven/bun:latest
  cache:
    <<: *cache_template
    policy: pull
  script:
    - echo "ğŸ§ª Running frontend tests with coverage..."
    - cd typescript/frontend
    - bun run test:coverage
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: typescript/frontend/coverage/cobertura-coverage.xml
    paths:
      - typescript/frontend/coverage/
    expire_in: 1 week
  needs: ["install_dependencies"]
  <<: *rules_frontend

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¤‰æ›´æ™‚ã®ã¿ï¼‰
test:backend:
  stage: test
  image: oven/bun:latest
  services:
    - name: postgres:15
      alias: postgres
  variables:
    POSTGRES_DB: myapp_test
    POSTGRES_USER: testuser
    POSTGRES_PASSWORD: testpass
    POSTGRES_HOST_AUTH_METHOD: trust
    DATABASE_URL: "postgresql://testuser:testpass@postgres:5432/myapp_test"
  cache:
    <<: *cache_template
    policy: pull
  before_script:
    - apt-get update -qq && apt-get install -y -qq postgresql-client
    - echo "â³ PostgreSQLã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
    - until pg_isready -h postgres -p 5432 -U testuser; do sleep 1; done
  script:
    - echo "ğŸ§ª Running backend tests with coverage..."
    - cd typescript/backend
    - echo "ğŸ”§ Generating Prisma client..."
    - bun run db:generate
    - echo "ğŸš€ Running tests..."
    - bun run test:coverage
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: typescript/backend/coverage/cobertura-coverage.xml
    paths:
      - typescript/backend/coverage/
    expire_in: 1 week
  needs: ["install_dependencies"]
  <<: *rules_backend

# çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆä¸¡æ–¹ã«å½±éŸ¿ã™ã‚‹å¤‰æ›´æ™‚ï¼‰
test:integration:
  stage: test
  image: oven/bun:latest
  services:
    - name: postgres:15
      alias: postgres
  variables:
    POSTGRES_DB: myapp_test
    POSTGRES_USER: testuser
    POSTGRES_PASSWORD: testpass
    POSTGRES_HOST_AUTH_METHOD: trust
    DATABASE_URL: "postgresql://testuser:testpass@postgres:5432/myapp_test"
  cache:
    <<: *cache_template
    policy: pull
  before_script:
    - apt-get update -qq && apt-get install -y -qq postgresql-client
    - until pg_isready -h postgres -p 5432 -U testuser; do sleep 1; done
  script:
    - echo "ğŸ§ª Running integration tests..."
    - cd typescript/backend && bun run db:generate
    - cd ../backend && bun run test:coverage
    - cd ../frontend && bun run test:coverage
  needs: ["install_dependencies"]
  rules:
    # ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚„package.jsonå¤‰æ›´æ™‚ã¯çµ±åˆãƒ†ã‚¹ãƒˆ
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - package.json
        - bun.lock
        - "*.md"
        - ".gitlab-ci.yml"
    # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¯çµ±åˆãƒ†ã‚¹ãƒˆ
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ã‚«ãƒãƒ¬ãƒƒã‚¸æ¤œè¨¼ï¼ˆå®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã®ã¿ï¼‰
coverage:validation:
  stage: coverage-report
  image: oven/bun:latest
  cache:
    <<: *cache_template
    policy: pull
  script:
    - echo "ğŸ“Š Validating coverage thresholds..."
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
    - |
      if [ -f "typescript/frontend/coverage/cobertura-coverage.xml" ]; then
        echo "Frontend coverage validation:"
        cd typescript/frontend && bun run test:coverage --reporter=text
        cd ..
      fi
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
    - |
      if [ -f "typescript/backend/coverage/cobertura-coverage.xml" ]; then
        echo "Backend coverage validation:"
        cd typescript/backend && bun run test:coverage --reporter=text
      fi
    - echo "âœ… Coverage validation completed!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - typescript/**/*
        - package.json
        - bun.lock
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: false

# ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¤‰æ›´æ™‚ã®ã¿ï¼‰
build:frontend:
  stage: test
  image: oven/bun:latest
  cache:
    <<: *cache_template
    policy: pull
  script:
    - echo "ğŸ—ï¸ Building frontend for validation..."
    - cd typescript/frontend
    - bun run build
  artifacts:
    paths:
      - typescript/frontend/.next/
    expire_in: 1 hour
  needs: ["install_dependencies"]
  <<: *rules_frontend
